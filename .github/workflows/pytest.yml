name: Run Backend Tests

on:
  push:
    branches: [ "main" ]
    paths:
      - 'backend/**'  # Only run when backend files change
      - 'pytest.ini'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'backend/**'
      - 'pytest.ini'

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip' # Caches dependencies for faster runs

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f backend/requirements.txt ]; then pip install -r backend/requirements.txt; fi
        # Ensure pytest-cov is installed for coverage reporting
        pip install pytest pytest-cov coverage

    - name: Run Pytest
      env:
        # Crucial: Add backend/src to PYTHONPATH so imports like 'from Services...' work
        PYTHONPATH: ${{ github.workspace }}/backend/src
        # Mock API keys to prevent tests from failing due to missing credentials
        GITHUB_TOKEN: "mock_token"
        HUGGINGFACE_TOKEN: "mock_token"
        OPENAI_API_KEY: "mock_token"
        POSTGRES_DB: "test_db"
        POSTGRES_USER: "user"
        POSTGRES_PASSWORD: "password"
        POSTGRES_HOST: "localhost"
      run: |
        # Run pytest with coverage flags:
        # --cov=backend/src: Measures coverage for your source code folder
        # --cov-report=term-missing: Prints the table to the console logs and lists missing lines
        python -m pytest -c pytest.ini --cov=backend/src --cov-report=term-missing